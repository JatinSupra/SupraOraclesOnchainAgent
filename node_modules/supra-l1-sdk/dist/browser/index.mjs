import{TxnBuilderTypes as o,BCS as d,HexString as A,SupraAccount as G}from"supra-l1-sdk-core";import W from"axios";var T=u=>{let t=new Array;return u.forEach(e=>{let n=e.value;t.push({struct:{address:n.address.toHexString().toString(),module:n.module_name.value,name:n.name.value,type_args:T(n.type_args)}})}),t},_=u=>{let t=new Array;for(let e=0;e<u.length;e++)t.push(Array.from(u[e]));return t},y=u=>{let t=u.toLowerCase();if(t.length<66)return t.startsWith("0x")?t=t.slice(2).padStart(64,"0"):t=t.padStart(64,"0"),"0x"+t;if(t.length===66&&t.startsWith("0x"))return t;throw new Error("Invalid address. With '0x', address length should be exactly 66 characters.")},S=u=>new Promise(t=>{setTimeout(t,u)});var x=(n=>(n.Success="Success",n.Failed="Failed",n.Pending="Pending",n))(x||{}),f=(a=>(a.CoinTransfer="CoinTransfer",a.EntryFunctionCall="EntryFunctionCall",a.ScriptCall="ScriptCall",a.AutomationRegistration="AutomationRegistration",a))(f||{});var R=6,b=300,E=1e3,p=15,w=BigInt(5e5),v=BigInt(100),N=300,P=1e3,m="0x0000000000000000000000000000000000000000000000000000000000000001",I=!1,O=!1,C=10,U=1020,M="SUPRA::RawTransaction",F="SUPRA::RawTransactionWithData";import D from"js-sha3";var B=class u{constructor(t,e=6){this.supraNodeURL=t,this.chainId=new o.ChainId(e)}static async init(t){let e=new u(t);return e.chainId=await e.getChainId(),e}async sendRequest(t,e,n){if(!t&&n===void 0)throw new Error("POST request requires a 'data' payload.");let a={method:t?"get":"post",baseURL:this.supraNodeURL,url:e,...t?{}:{data:n,headers:{"Content-Type":"application/json"}}},i=await W(a);if(i.status===404)throw new Error("Invalid URL \u2014 path not found (404).");if(i.status===500)throw new Error("Server error \u2014 please try again later.");return i}async getChainId(){return new o.ChainId(Number((await this.sendRequest(!0,"/rpc/v1/transactions/chain_id")).data))}async getGasPrice(){return BigInt((await this.sendRequest(!0,"/rpc/v1/transactions/estimate_gas_price")).data.mean_gas_price)}async fundAccountWithFaucet(t){let n=(await this.sendRequest(!0,`/rpc/v1/wallet/faucet/${t.toString()}`)).data;if(typeof n!="object"||n===null)throw new Error("Unexpected response format. Please try faucet later.");if(!("Accepted"in n))throw new Error("Faucet request failed \u2014 'Accepted' field not found in response.");let a=n.Accepted;return{status:await this.waitForTransactionCompletion(a),transactionHash:a}}async isAccountExists(t){let e=await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}`);return!(e.data===null||e.status===202)}async getAccountInfo(t){let n=(await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}`)).data;if(!n||typeof n!="object")throw new Error("Account does not exist or an invalid account was provided.");return{sequence_number:BigInt(n.sequence_number),authentication_key:n.authentication_key}}async getAccountResources(t,e){let n=`/rpc/v1/accounts/${t.toString()}/resources?count=${e?.count??15}`;return e?.start&&(n+=`&start=${e.start}`),(await this.sendRequest(!0,n)).data.Resources}async getResourceData(t,e){let a=(await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}/resources/${e}`)).data?.result;if(!Array.isArray(a)||a.length===0||a[0]==null)throw new Error(`Resource of type '${e}' not found for account ${t.toString()}.`);return a[0]}async getTransactionStatus(t){let e=await this.sendRequest(!0,`/rpc/v1/transactions/${t}`);return e.data==null?null:e.data.status=="Unexecuted"?"Pending":e.data.status=="Fail"?"Failed":e.data.status}getCoinChangeAmount(t,e){let n=new Map;e.forEach(i=>{if((i.type==="0x1::coin::CoinDeposit"||i.type==="0x1::coin::CoinWithdraw")&&"0x"+i.data.account.substring(2,i.data.account).padStart(64,"0")===t){if(i.type==="0x1::coin::CoinDeposit"){let r=n.get(i.data.coin_type);r!=null?n.set(i.data.coin_type,{totalDeposit:r.totalDeposit+BigInt(i.data.amount),totalWithdraw:r.totalWithdraw}):n.set(i.data.coin_type,{totalDeposit:BigInt(i.data.amount),totalWithdraw:BigInt(0)})}else if(i.type==="0x1::coin::CoinWithdraw"){let r=n.get(i.data.coin_type);r!=null?n.set(i.data.coin_type,{totalDeposit:r.totalDeposit,totalWithdraw:r.totalWithdraw+BigInt(i.data.amount)}):n.set(i.data.coin_type,{totalDeposit:BigInt(0),totalWithdraw:BigInt(i.data.amount)})}}});let a=[];return n.forEach((i,r)=>{a.push({coinType:r,amount:i.totalDeposit-i.totalWithdraw})}),a}getTransactionInsights(t,e){let n={coinReceiver:"",coinChange:[{amount:BigInt(0),coinType:""}],type:"EntryFunctionCall"};if(e.payload.Move.type==="entry_function_payload")if(e.payload.Move.function==="0x1::supra_account::transfer"){let a=BigInt(e.payload.Move.arguments[1]);t===e.header.sender.Move&&(a*=BigInt(-1)),n.coinReceiver=e.payload.Move.arguments[0],n.coinChange[0]={amount:a,coinType:"0x1::supra_coin::SupraCoin"},n.type="CoinTransfer"}else if(e.payload.Move.function==="0x1::supra_account::transfer_coins"||e.payload.Move.function==="0x1::coin::transfer"){let a=BigInt(e.payload.Move.arguments[1]);t===e.header.sender.Move&&(a*=BigInt(-1)),n.coinReceiver=e.payload.Move.arguments[0],n.coinChange[0]={amount:a,coinType:e.payload.Move.type_arguments[0]},n.type="CoinTransfer"}else e.status==="Success"&&(n.coinChange=this.getCoinChangeAmount(t,e.output.Move.events));else{if(e.payload.Move.type==="script_payload")n.type="ScriptCall";else if(e.payload.Move.type==="automation_registration_payload")n.type="AutomationRegistration";else throw new Error("Unsupported transaction payload type.");e.status==="Success"&&(n.coinChange=this.getCoinChangeAmount(t,e.output.Move.events))}return n}async getTransactionDetail(t,e){let n=await this.sendRequest(!0,`/rpc/v1/transactions/${e}`);return n.data==null?null:n.data.status==="Pending"||n.data.output===null||n.data.header===null?{txHash:e,sender:n.data.header.sender.Move,sequenceNumber:n.data.header.sequence_number,maxGasAmount:n.data.header.max_gas_amount,gasUnitPrice:n.data.header.gas_unit_price,gasUsed:void 0,transactionCost:void 0,txExpirationTimestamp:Number(n.data.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:void 0,status:n.data.status,events:void 0,blockNumber:void 0,blockHash:void 0,transactionInsights:this.getTransactionInsights(t.toString(),n.data),vm_status:void 0}:{txHash:e,sender:n.data.header.sender.Move,sequenceNumber:n.data.header.sequence_number,maxGasAmount:n.data.header.max_gas_amount,gasUnitPrice:n.data.header.gas_unit_price,gasUsed:n.data.output?.Move.gas_used,transactionCost:n.data.header.gas_unit_price*n.data.output?.Move.gas_used,txExpirationTimestamp:Number(n.data.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:Number(n.data.block_header.timestamp.microseconds_since_unix_epoch),status:n.data.status=="Fail"||n.data.status=="Invalid"?"Failed":n.data.status,events:n.data.output?.Move.events,blockNumber:n.data.block_header.height,blockHash:n.data.block_header.hash,transactionInsights:this.getTransactionInsights(t.toString(),n.data),vm_status:n.data.output.Move.vm_status}}async getAccountTransactionsDetail(t,e){let n=`/rpc/v1/accounts/${t.toString()}/transactions?count=${e?.count??15}`;e?.start&&(n+=`&start=${e.start}`);let a=await this.sendRequest(!0,n);if(a.data.record==null)throw new Error("Account does not exist or an invalid account was provided.");let i=[];return a.data.record.forEach(r=>{i.push({txHash:r.hash,sender:r.header.sender.Move,sequenceNumber:r.header.sequence_number,maxGasAmount:r.header.max_gas_amount,gasUnitPrice:r.header.gas_unit_price,gasUsed:r.output.Move.gas_used,transactionCost:r.header.gas_unit_price*r.output.Move.gas_used,txExpirationTimestamp:Number(r.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:Number(r.block_header.timestamp.microseconds_since_unix_epoch),status:r.status==="Fail"||r.status==="Invalid"?"Failed":r.status,events:r.output.Move.events,blockNumber:r.block_header.height,blockHash:r.block_header.hash,transactionInsights:this.getTransactionInsights(t.toString(),r),vm_status:r.output.Move.vm_status})}),i}async getCoinTransactionsDetail(t,e){let n=`/rpc/v1/accounts/${t.toString()}/coin_transactions?count=${e?.count??15}`;e?.start&&(n+=`&start=${e?.start}`);let a=await this.sendRequest(!0,n);if(a.data.record==null)throw new Error("Account does not exist or an invalid account was provided.");let i=[];return a.data.record.forEach(r=>{i.push({txHash:r.hash,sender:r.header.sender.Move,sequenceNumber:r.header.sequence_number,maxGasAmount:r.header.max_gas_amount,gasUnitPrice:r.header.gas_unit_price,gasUsed:r.output.Move.gas_used,transactionCost:r.header.gas_unit_price*r.output.Move.gas_used,txExpirationTimestamp:Number(r.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:Number(r.block_header.timestamp.microseconds_since_unix_epoch),status:r.status==="Fail"||r.status==="Invalid"?"Failed":r.status,events:r.output.Move.events,blockNumber:r.block_header.height,blockHash:r.block_header.hash,transactionInsights:this.getTransactionInsights(t.toString(),r),vm_status:r.output.Move.vm_status})}),{transactions:i,cursor:a.data.cursor}}async getAccountCompleteTransactionsDetail(t,e=15){let n=await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}/coin_transactions?count=${e}`),a=await this.sendRequest(!0,`/rpc/v1/accounts/${t.toString()}/transactions?count=${e}`),i=[];n.data.record!=null&&i.push(...n.data.record),a.data.record!=null&&i.push(...a.data.record);let r=i.filter((s,l,g)=>l===g.findIndex(h=>h.hash===s.hash));r.sort((s,l)=>s.block_header.timestamp.microseconds_since_unix_epoch<l.block_header.timestamp.microseconds_since_unix_epoch?1:-1);let c=[];return r.forEach(s=>{c.push({txHash:s.hash,sender:s.header.sender.Move,sequenceNumber:s.header.sequence_number,maxGasAmount:s.header.max_gas_amount,gasUnitPrice:s.header.gas_unit_price,gasUsed:s.output.Move.gas_used,transactionCost:s.header.gas_unit_price*s.output.Move.gas_used,txExpirationTimestamp:Number(s.header.expiration_timestamp.microseconds_since_unix_epoch),txConfirmationTime:Number(s.block_header.timestamp.microseconds_since_unix_epoch),status:s.status==="Fail"||s.status==="Invalid"?"Failed":s.status,events:s.output.Move.events,blockNumber:s.block_header.height,blockHash:s.block_header.hash,transactionInsights:this.getTransactionInsights(t.toString(),s),vm_status:s.output.Move.vm_status})}),c}async getCoinInfo(t){let e=await this.getResourceData(new A(t.split("::")[0]),`${m}::coin::CoinInfo<${t}>`);return{name:e.name,symbol:e.symbol,decimals:e.decimals}}async getAccountSupraCoinBalance(t){return BigInt((await this.getResourceData(t,"0x1::coin::CoinStore<0x1::supra_coin::SupraCoin>")).coin.value)}async getAccountCoinBalance(t,e){return BigInt((await this.getResourceData(t,`0x1::coin::CoinStore<${e}>`)).coin.value)}async invokeViewMethod(t,e,n){return(await this.sendRequest(!1,"/rpc/v1/view",{function:t,type_arguments:e,arguments:n})).data.result}async getTableItemByKey(t,e,n,a){return(await this.sendRequest(!1,`/rpc/v1/tables/${t}/item`,{key_type:e,value_type:n,key:a})).data}async waitForTransactionCompletion(t){for(let e=0;e<300;e++){let n=await this.getTransactionStatus(t);if(n===null||n=="Pending")await S(1e3);else return n}return"Pending"}async sendTx(t,e){(e?.enableTransactionSimulation??I)===!0&&await this.simulateTx(t);let n=await this.sendRequest(!1,"/rpc/v1/transactions/submit",t);return console.log("Transaction Request Sent, Waiting For Completion"),{txHash:n.data,result:(e?.enableWaitForTransaction??O)===!0?await this.waitForTransactionCompletion(n.data):"Pending"}}static getSupraTransactionSignatureMessage(t){let e=Uint8Array.from(Buffer.from(D.sha3_256(t instanceof o.RawTransaction?M:F),"hex")),n=new Uint8Array(d.bcsToBytes(t)),a=new Uint8Array(e.length+n.length);return a.set(e),a.set(n,e.length),a}static signSupraTransaction(t,e){return t.signBuffer(u.getSupraTransactionSignatureMessage(e))}static signSupraMultiTransaction(t,e){let n=new o.Ed25519Signature(u.signSupraTransaction(t,e).toUint8Array());return new o.AccountAuthenticatorEd25519(new o.Ed25519PublicKey(t.signingKey.publicKey),n)}getTransactionPayloadJSON(t){if(t instanceof o.TransactionPayloadEntryFunction)return{EntryFunction:{module:{address:t.value.module_name.address.toHexString().toString(),name:t.value.module_name.name.value},function:t.value.function_name.value,ty_args:T(t.value.ty_args),args:_(t.value.args)}};if(t instanceof o.TransactionPayloadAutomationRegistration){if(t.value instanceof o.AutomationRegistrationParamsV1)return{AutomationRegistration:{V1:{automated_function:{module:{address:t.value.value.automated_function.module_name.address.toHexString().toString(),name:t.value.value.automated_function.module_name.name.value},function:t.value.value.automated_function.function_name.value,ty_args:T(t.value.value.automated_function.ty_args),args:_(t.value.value.automated_function.args)},max_gas_amount:Number(t.value.value.max_gas_amount),gas_price_cap:Number(t.value.value.gas_price_cap),automation_fee_cap_for_epoch:Number(t.value.value.automation_fee_cap_for_epoch),expiration_timestamp_secs:Number(t.value.value.expiration_timestamp_secs),aux_data:_(t.value.value.aux_data)}}};throw new Error("Unknown variant of `AutomationRegistrationParams`")}else throw new Error("Unknown variant of `TransactionPayload`")}getRawTxnJSON(t){return{sender:t.sender.toHexString().toString(),sequence_number:Number(t.sequence_number),payload:this.getTransactionPayloadJSON(t.payload),max_gas_amount:Number(t.max_gas_amount),gas_unit_price:Number(t.gas_unit_price),expiration_timestamp_secs:Number(t.expiration_timestamp_secs),chain_id:t.chain_id.value}}getSendTxPayload(t,e){return{Move:{raw_txn:this.getRawTxnJSON(e),authenticator:{Ed25519:{public_key:t.pubKey().toString(),signature:u.signSupraTransaction(t,e).toString()}}}}}async sendTxUsingSerializedRawTransaction(t,e,n){let a=this.getSendTxPayload(t,o.RawTransaction.deserialize(new d.Deserializer(e)));return await this.sendTx(a,n)}async sendTxUsingSerializedRawTransactionAndSignature(t,e,n,a){let i={Move:{raw_txn:this.getRawTxnJSON(o.RawTransaction.deserialize(new d.Deserializer(n))),authenticator:{Ed25519:{public_key:t.toString(),signature:e.toString()}}}};return await this.sendTx(i,a)}async sendSponsorTransaction(t,e,n,a,i,r=[],c){let s=[];r.forEach(g=>{s.push(this.getED25519AuthenticatorJSON(g))});let l={Move:{raw_txn:this.getRawTxnJSON(n),authenticator:{FeePayer:{sender:this.getED25519AuthenticatorJSON(a),secondary_signer_addresses:e,secondary_signers:s,fee_payer_address:t,fee_payer_signer:this.getED25519AuthenticatorJSON(i)}}}};return await this.sendTx(l,c)}async sendMultiAgentTransaction(t,e,n,a,i){let r=[];a.forEach(s=>{r.push(this.getED25519AuthenticatorJSON(s))});let c={Move:{raw_txn:this.getRawTxnJSON(e),authenticator:{MultiAgent:{sender:this.getED25519AuthenticatorJSON(n),secondary_signer_addresses:t,secondary_signers:r}}}};return await this.sendTx(c,i)}getED25519AuthenticatorJSON(t){return{Ed25519:{public_key:Buffer.from(t.public_key.value).toString("hex"),signature:Buffer.from(t.signature.value).toString("hex")}}}createRawTxObjectInner(t,e,n,a){return new o.RawTransaction(new o.AccountAddress(t.toUint8Array()),e,n,a?.maxGas??w,a?.gasUnitPrice??v,a?.txExpiryTime??BigInt(Math.ceil(Date.now()/P)+N),this.chainId)}async createRawTxObject(t,e,n,a,i,r,c,s){let l=new o.TransactionPayloadEntryFunction(new o.EntryFunction(new o.ModuleId(new o.AccountAddress(new A(y(n)).toUint8Array()),new o.Identifier(a)),new o.Identifier(i),r,c));return this.createRawTxObjectInner(t,e,l,s)}async createSerializedRawTxObject(t,e,n,a,i,r,c,s){return d.bcsToBytes(await this.createRawTxObject(t,e,n,a,i,r,c,s))}createSerializedAutomationRegistrationTxPayloadRawTxObject(t,e,n,a,i,r,c,s,l,g,h,J,H){let q=new o.TransactionPayloadAutomationRegistration(new o.AutomationRegistrationParamsV1(new o.AutomationRegistrationParamsV1Data(new o.EntryFunction(new o.ModuleId(new o.AccountAddress(new A(y(n)).toUint8Array()),new o.Identifier(a)),new o.Identifier(i),r,c),s,l,g,h,J)));return d.bcsToBytes(this.createRawTxObjectInner(t,e,q,H))}static createSignedTransaction(t,e){return new o.SignedTransaction(e,new o.AccountAuthenticatorEd25519(new o.Ed25519PublicKey(t.pubKey().toUint8Array()),new o.Ed25519Signature(u.signSupraTransaction(t,e).toUint8Array())))}static deriveTransactionHash(t){return D.keccak256(d.bcsToBytes(t))}async transferSupraCoin(t,e,n,a){if(a?.optionalTransactionPayloadArgs&&!a?.optionalTransactionPayloadArgs?.maxGas){let r=BigInt(C);await this.isAccountExists(e)==!1&&(r=BigInt(U)),a.optionalTransactionPayloadArgs.maxGas=r}let i=this.getSendTxPayload(t,await this.createRawTxObject(t.address(),(await this.getAccountInfo(t.address())).sequence_number,m,"supra_account","transfer",[],[e.toUint8Array(),d.bcsSerializeUint64(n)],a?.optionalTransactionPayloadArgs));return await this.sendTx(i,a?.enableTransactionWaitAndSimulationArgs)}async transferCoin(t,e,n,a,i){let r=this.getSendTxPayload(t,await this.createRawTxObject(t.address(),(await this.getAccountInfo(t.address())).sequence_number,m,"supra_account","transfer_coins",[new o.TypeTagParser(a).parseTypeTag()],[e.toUint8Array(),d.bcsSerializeUint64(n)],i?.optionalTransactionPayloadArgs));return await this.sendTx(r,i?.enableTransactionWaitAndSimulationArgs)}async publishPackage(t,e,n,a){let i=new d.Serializer,r=[];for(let s=0;s<n.length;s++)r.push(new o.Module(Uint8Array.from(n[s])));d.serializeVector(r,i);let c=this.getSendTxPayload(t,await this.createRawTxObject(t.address(),(await this.getAccountInfo(t.address())).sequence_number,m,"code","publish_package_txn",[],[d.bcsSerializeBytes(e),i.getBytes()],a?.optionalTransactionPayloadArgs));return await this.sendTx(c,a?.enableTransactionWaitAndSimulationArgs)}async simulateTx(t){let e=t.Move.authenticator,n=JSON.parse(JSON.stringify(e));t.Move.authenticator=n,this.unsetAuthenticatorSignatures(t.Move.authenticator);let a=await this.sendRequest(!1,"/rpc/v1/transactions/simulate",t);if(t.Move.authenticator=e,a.data.output.Move.vm_status!=="Executed successfully")throw new Error(`Transaction simulation failed. Reason: ${a?.data?.output?.Move?.vm_status}`);return console.log("Transaction Simulation Done"),a.data}unsetAuthenticatorSignatures(t){let e="0x"+"0".repeat(128);"Ed25519"in t?t.Ed25519.signature=e:"FeePayer"in t?(t.FeePayer.sender.Ed25519.signature=e,t.FeePayer.fee_payer_signer.Ed25519.signature=e,t.FeePayer.secondary_signers.forEach(n=>{n.Ed25519.signature=e})):(t.MultiAgent.sender.Ed25519.signature=e,t.MultiAgent.secondary_signers.forEach(n=>{n.Ed25519.signature=e}))}async simulateTxUsingSerializedRawTransaction(t,e){let n={Move:{raw_txn:this.getRawTxnJSON(o.RawTransaction.deserialize(new d.Deserializer(e))),authenticator:t}};return await this.simulateTx(n)}};export{d as BCS,R as DEFAULT_CHAIN_ID,I as DEFAULT_ENABLE_SIMULATION,v as DEFAULT_GAS_PRICE,C as DEFAULT_MAX_GAS_FOR_SUPRA_TRANSFER_WHEN_RECEIVER_EXISTS,U as DEFAULT_MAX_GAS_FOR_SUPRA_TRANSFER_WHEN_RECEIVER_NOT_EXISTS,w as DEFAULT_MAX_GAS_UNITS,p as DEFAULT_RECORDS_ITEMS_COUNT,N as DEFAULT_TX_EXPIRATION_DURATION,O as DEFAULT_WAIT_FOR_TX_COMPLETION,E as DELAY_BETWEEN_POOLING_REQUEST,A as HexString,b as MAX_RETRY_FOR_TRANSACTION_COMPLETION,P as MILLISECONDS_PER_SECOND,M as RAW_TRANSACTION_SALT,F as RAW_TRANSACTION_WITH_DATA_SALT,m as SUPRA_FRAMEWORK_ADDRESS,G as SupraAccount,B as SupraClient,x as TransactionStatus,f as TxTypeForTransactionInsights,o as TxnBuilderTypes};
//# sourceMappingURL=index.mjs.map